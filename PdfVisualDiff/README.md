# PdfVisualDiff

`PdfVisualDiff` is a .NET 9 command-line wrapper around the open-source [`diff-pdf`](https://vslavik.github.io/diff-pdf/) utility. It orchestrates the external tool, captures its stdout/stderr, and emits deterministic artifacts (`diff.pdf`, `report.json`) suitable for CI pipelines.

## Requirements

- .NET SDK 9.0+
- `diff-pdf` installed and available on `PATH` (e.g., `brew install diff-pdf` on macOS, `apt install diffpdf` on Debian/Ubuntu). You can also pass `--diff-pdf-path` to point to a specific binary.

## Build

```bash
dotnet build PdfVisualDiff.sln
```

## CLI usage

```
pdf-visual-diff <baseline.pdf> <candidate.pdf> --out <output-dir> [options]
```

Supported options:

| Option | Description |
| --- | --- |
| `--page-range 1-3,5` | Forwarded to `diff-pdf --pages` to limit comparison to specific pages. |
| `--diff-pdf-path <path>` | Explicit path to the `diff-pdf` executable. |

Legacy options (`--dpi`, `--mode`, `--threshold`, `--antialias-tolerance`, `--max-pages`, `--masks`, `--geometry-check`, `--parallel`) are accepted for compatibility but ignored; the CLI prints a warning if you set them.

Example:

```bash
dotnet run --project PdfVisualDiff/src/PdfVisualDiff \
  samples/A.pdf samples/B.pdf \
  --out artifacts/diff \
  --page-range 1-3 \
  --diff-pdf-path /opt/homebrew/bin/diff-pdf
```

Artifacts under `--out`:

- `diff.pdf` – generated by `diff-pdf --output-diff` (only present when differences are detected).
- `report.json` – contains `passed`, the raw exit code, stdout/stderr, baseline/candidate paths, and the page filter used.

Exit codes mirror `diff-pdf`: `0` identical, `1` different, `2` error (e.g., missing files or tool).

## Testing

```bash
dotnet test PdfVisualDiff.sln
```

The CLI tests are skipped automatically if `diff-pdf` is not installed. They exercise both the identical and the differing sample PDFs in `samples/`. The core unit tests cover the page-range parser/normaliser.

## CI notes

1. Install `diff-pdf` in the CI image (`brew install diff-pdf`, `apt install diffpdf`, etc.).
2. Cache `~/.nuget/packages` between runs for faster restores.
3. Upload `report.json` and `diff.pdf` as failure artifacts to aid investigation.

## References

- [`diff-pdf` project page](https://vslavik.github.io/diff-pdf/)
