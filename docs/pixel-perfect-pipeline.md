# Pixel-Perfect DOCX ↔ PDF Validation (LibreOffice Baseline)

This workflow locks a reproducible DOCX→PDF baseline with LibreOffice, enforces font parity, and compares candidate PDFs (generated by `DocxToPdf.Demo`) both visually and geometrically.

## 1. Tooling & Fonts (macOS host)

```bash
# LibreOffice headless CLI
brew install --cask libreoffice

# Poppler utilities (pdffonts/pdfto... for embedding checks)
brew install poppler

# Noto families to avoid font substitution
brew install --cask font-noto-sans
brew install --cask font-noto-serif
brew install --cask font-noto-emoji

# Optional CJK coverage (GitHub releases occasionally reset connections).
# Retry as needed, or download manually:
#   brew install --cask font-noto-sans-cjk-sc
```

> `brew install --cask font-noto-sans-cjk-sc` currently fails intermittently with `curl: (56) Recv failure`. If the tap keeps failing, download the archive from <https://github.com/notofonts/noto-cjk/releases> and copy the `.otf/.ttc` files into `~/Library/Fonts` so baseline/candidate renderers share the same glyph set.

## 2. Baseline PDF (LibreOffice Writer export)

```bash
soffice --headless --nologo --nofirststartwizard \
  --convert-to pdf:writer_pdf_Export \
  --outdir out/ \
  samples/doc-under-test.docx
```

* `writer_pdf_Export` is the official Writer pipeline (see LibreOffice filter table).
* For determinism in CI, run this inside a pinned LibreOffice container (e.g., `ghcr.io/lcrea/libreoffice-headless:7.6` or a custom image with `/usr/bin/soffice` preinstalled and the Noto fonts copied into `/usr/share/fonts`).

## 3. Candidate PDF (DocxToPdf.Demo)

```bash
dotnet run --project DocxToPdf.Demo \
  -- render samples/doc-under-test.docx \
  -o out/candidate.pdf \
  --log-tabs
```

* `--log-tabs` (or `--log-numbering`) forwards diagnostics from `DocxToPdf.Sdk` so CI logs show any tab/numbering decisions alongside mismatches.

## 4. Font Embedding Gate

```bash
pdffonts out/baseline.pdf
pdffonts out/candidate.pdf
```

Reject the build if any row reports `no` under `emb`. Ensuring both PDFs embed the same font set prevents machine-specific substitutions later.

## 5. Visual Diff via PDFium Rasterization

1. Add PDFium binaries via NuGet (works cross-platform):
   * `PdfiumViewer.Core`
   * `PdfiumViewer.Native.osx-arm64` (or the matching RID package for your CI OS)
2. Use PDFium to rasterize both PDFs at 300 DPI into `.png` bitmaps (one per page). Example shell:

```bash
dotnet run --project tools/PdfRasterize \
  -- --input out/baseline.pdf --dpi 300 --out out/baseline/renders
dotnet run --project tools/PdfRasterize \
  -- --input out/candidate.pdf --dpi 300 --out out/candidate/renders

python scripts/pixel_diff.py \
  --baseline out/baseline/renders \
  --candidate out/candidate/renders
```

`pixel_diff.py` should fail-fast on any non-zero pixel delta (or use a tiny tolerance for single‑pixel AA seams). Emit per-page diff images as CI artifacts when mismatches occur.

## 6. Text Geometry Diff with PdfPig

Use [UglyToad/PdfPig](https://github.com/UglyToad/PdfPig) to parse both PDFs and compare:

* Word sequence per page (text order)
* Bounding boxes: `|Δx|, |Δy|, |Δwidth|, |Δheight| ≤ 0.25 pt`

Example outline (pseudo-code):

```csharp
var baseline = PdfDocument.Open("out/baseline.pdf");
var candidate = PdfDocument.Open("out/candidate.pdf");

foreach (var pageIndex in pages)
{
    var baseWords = baseline.GetPage(pageIndex).GetWords().ToList();
    var candWords = candidate.GetPage(pageIndex).GetWords().ToList();
    // Compare word text and rectangle metrics with tolerance
}
```

Log any discrepancies as structured JSON so CI can surface them inline.

## 7. CI Recipe

1. **Container**: start from a base image with LibreOffice + Poppler + Noto fonts installed (or install them at job start).
2. **Baseline**: run the `soffice --convert-to pdf:writer_pdf_Export` command above (output `out/baseline.pdf`).
3. **Candidate**: run `DocxToPdf.Demo render …` to `out/candidate.pdf`.
4. **Font gate**: `pdffonts` on both outputs; ensure every font is embedded.
5. **Visual diff**: rasterize with PDFium and run pixel diff.
6. **Geometry diff**: run the PdfPig-based checker with ±0.25 pt tolerance.
7. Upload artifacts (`baseline.pdf`, `candidate.pdf`, raster PNGs, diff JSON) on failure.

### Golden baselines for current DOCX samples

All sample documents in `samples/*.docx` now have LibreOffice-rendered references stored in `samples/golden/*.pdf`:

| DOCX | Baseline PDF |
| --- | --- |
| `bullets-basic.docx` | `samples/golden/bullets-basic.pdf` |
| `lorem.docx` | `samples/golden/lorem.pdf` |
| `numbering-multilevel.docx` | `samples/golden/numbering-multilevel.pdf` |
| `styles-theme.docx` | `samples/golden/styles-theme.pdf` |
| `styles-theme-alt.docx` | `samples/golden/styles-theme-alt.pdf` |
| `tabs-alignment.docx` | `samples/golden/tabs-alignment.pdf` |

Refresh the baselines whenever the DOCX inputs change:

```bash
mkdir -p samples/golden
for docx in samples/*.docx; do
  soffice --headless --nologo --nofirststartwizard \
    --convert-to pdf:writer_pdf_Export \
    --outdir samples/golden "$docx"
done
```

## 8. Troubleshooting

| Issue | Fix |
| --- | --- |
| `soffice` not found | Ensure `/Applications/LibreOffice.app/Contents/MacOS/soffice` is on `$PATH` (`brew install --cask libreoffice` already symlinks `/opt/homebrew/bin/soffice`). |
| Font mismatch | Reinstall the Noto casks or copy fonts into the CI image (`fc-cache -f` afterwards). |
| `font-noto-sans-cjk-sc` download fails | Retry or download manually and copy into `~/Library/Fonts` / `/usr/share/fonts`. |
| PDFium native libs missing | Reference `PdfiumViewer.Native.<rid>` in the rasterizer project; runtime RID must match the CI OS/arch. |

Document history:
* Installed via Homebrew: LibreOffice 25.8.2 (soffice CLI), Poppler (pdffonts), Noto Sans/Serif/Emoji font sets (2025‑05‑22).
